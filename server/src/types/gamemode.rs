//! Note: This entire module is an exercise
//! in bashing the trait system over the
//! head until it lets us do what we want
//! safely.

use shred::ResourceId;
use specs::prelude::*;

use crate::types::*;

use std::any::Any;
use std::marker::PhantomData;
use std::ops::{Deref, DerefMut};

use crate::protocol::GameType;

pub trait GameMode: Any + Sync + Send {
  fn assign_team(&mut self, player: Entity) -> Team;
  fn spawn_pos(&mut self, player: Entity, team: Team) -> Position;
  fn assign_plane(&mut self, _player: Entity, _team: Team) -> Plane {
    Plane::Predator
  }

  fn gametype(&self) -> GameType;
  fn room(&self) -> String;
}

pub trait GameModeWrapper: Send + Sync {
  fn as_gamemode_ref<'a>(&'a self) -> &'a dyn GameMode;
  fn as_gamemode_mut<'a>(&'a mut self) -> &'a mut dyn GameMode;
  fn as_any_ref<'a>(&'a self) -> &'a dyn Any;
  fn as_any_mut<'a>(&'a mut self) -> &'a mut dyn Any;
}

pub struct GameModeWrapperImpl<T: GameMode + Sync + Send + 'static> {
  pub val: T,
}

impl<T> GameModeWrapper for GameModeWrapperImpl<T>
where
  T: GameMode + Sync + Send + 'static,
{
  fn as_gamemode_ref<'a>(&'a self) -> &'a dyn GameMode {
    &self.val
  }
  fn as_gamemode_mut<'a>(&'a mut self) -> &'a mut dyn GameMode {
    &mut self.val
  }

  fn as_any_ref<'a>(&'a self) -> &'a dyn Any {
    &self.val
  }
  fn as_any_mut<'a>(&'a mut self) -> &'a mut dyn Any {
    &mut self.val
  }
}

pub struct GameModeInternal(pub Box<dyn GameModeWrapper>);

pub struct GameModeWriter<'a, T: ?Sized> {
  inner: WriteExpect<'a, GameModeInternal>,
  marker: PhantomData<T>,
}

impl<'a> GameModeWriter<'a, dyn GameMode> {
  pub fn get(&self) -> &dyn GameMode {
    self.inner.0.as_gamemode_ref()
  }
  pub fn get_mut(&mut self) -> &mut dyn GameMode {
    self.inner.0.as_gamemode_mut()
  }
}

impl<'a, T> SystemData<'a> for GameModeWriter<'a, T>
where
  T: GameMode + Sync + Send + ?Sized,
{
  fn setup(res: &mut Resources) {
    WriteExpect::<'a, GameModeInternal>::setup(res);
  }

  fn fetch(res: &'a Resources) -> Self {
    Self {
      inner: WriteExpect::<'a, GameModeInternal>::fetch(res),
      marker: PhantomData,
    }
  }

  fn reads() -> Vec<ResourceId> {
    WriteExpect::<'a, GameModeInternal>::reads()
  }

  fn writes() -> Vec<ResourceId> {
    WriteExpect::<'a, GameModeInternal>::writes()
  }
}

impl<'a, T> Deref for GameModeWriter<'a, T>
where
  T: GameMode,
{
  type Target = T;

  fn deref(&self) -> &Self::Target {
    match self.inner.0.as_any_ref().downcast_ref() {
      Some(x) => x,
      None => {
        panic!("Game mode was not expected type when using GameModeWriter");
      }
    }
  }
}

impl<'a, T> DerefMut for GameModeWriter<'a, T>
where
  T: GameMode,
{
  fn deref_mut(&mut self) -> &mut Self::Target {
    match self.inner.0.as_any_mut().downcast_mut() {
      Some(x) => x,
      None => {
        panic!("Game mode was not expected type when using GameModeWriter");
      }
    }
  }
}
